#!/bin/sh

base_dir=$(cd "$(dirname "$0")" && pwd)

uname="$(uname)"
is_macos=$([ $uname = Darwin ] && echo true)
is_linux=$([ $uname = Linux  ] && echo true)
is_wsl=$([ $is_linux ] && grep -i -q "microsoft" /proc/version && echo true)

# Dot files

[ -e ~/.gitconfig       ] || ln -svf "$base_dir/gitconfig" ~/.gitconfig
[ -e ~/.zshrc           ] || ln -svf "$base_dir/zshrc" ~/.zshrc
[ -e ~/.zsh_plugins.txt ] || ln -svf "$base_dir/zsh_plugins.txt" ~/.zsh_plugins.txt

# .config files

[ -d ~/.config               ] || mkdir ~/.config
[ -e ~/.config/starship.toml ] || ln -svf "$base_dir/starship.toml" ~/.config/starship.toml

# Windows (WSL)

install_apt() {
    if dpkg -l | grep -qw $1; then
        echo "$1 is already installed."
    else
        sudo apt install -y $1
    fi
}

if [ $is_wsl ]; then
    install_apt neovim
    install_apt zsh

    antidote_url="https://github.com/mattmc3/antidote.git"
    [ -e ~/.antidote ] || git clone --depth=1 "$antidote_url" ~/.antidote

    fzf_url="https://github.com/junegunn/fzf.git"
    if [ ! -d ~/.fzf ]; then
        git clone --depth 1 "$fzf_url" ~/.fzf
        ~/.fzf/install --key-bindings --completion --no-update-rc
    fi

    username=$(powershell.exe '$env:UserName' | sed -e 's/[^a-zA-Z0-9]*$//')
    [ -e ~/Windows ] || ln -svf "/mnt/c/Users/$username" ~/Windows
fi

# macOS

install_brew() {
    if brew list $1 &>/dev/null; then
        echo "$1 is already installed."
    else
        brew install $1
    fi
}

if [ $is_macos ]; then
    install_brew antidote
    install_brew fzf
    install_brew neovim
    install_brew starship
fi
